<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Stock Inventory Manager - Firebase</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState, useEffect } = React;

        function StockInventoryApp() {
            // State for items and packs
            const [items, setItems] = useState([]);
            const [packs, setPacks] = useState([]);
            const [isLoading, setIsLoading] = useState(false);
            const [isConnected, setIsConnected] = useState(false);
            const [error, setError] = useState(null);
            
            // Firebase configuration (user needs to replace with their own)
            const [firebaseConfig, setFirebaseConfig] = useState({
                apiKey: '',
                authDomain: '',
                projectId: '',
                storageBucket: '',
                messagingSenderId: '',
                appId: ''
            });
            
            const [configInput, setConfigInput] = useState('');
            const [showConfig, setShowConfig] = useState(true);
            
            // Form states
            const [newItemName, setNewItemName] = useState('');
            const [newItemStock, setNewItemStock] = useState('');
            const [showPackForm, setShowPackForm] = useState(false);
            const [newPackName, setNewPackName] = useState('');
            const [packComponents, setPackComponents] = useState([]);
            const [editingId, setEditingId] = useState(null);
            const [editName, setEditName] = useState('');
            const [searchQuery, setSearchQuery] = useState('');

            let db = null;

            // Load saved Firebase config from localStorage on mount
            useEffect(() => {
                const savedConfig = localStorage.getItem('firebaseConfig');
                if (savedConfig) {
                    try {
                        const parsedConfig = JSON.parse(savedConfig);
                        if (parsedConfig.apiKey && parsedConfig.projectId) {
                            setFirebaseConfig(parsedConfig);
                            setShowConfig(false);
                        }
                    } catch {
                        // Ignore invalid saved config
                    }
                }
            }, []);

            // Initialize Firebase
            const initializeFirebase = () => {
                try {
                    if (!firebase.apps.length) {
                        firebase.initializeApp(firebaseConfig);
                    }
                    db = firebase.firestore();
                    setIsConnected(true);
                    setError(null);
                    loadData();
                    return true;
                } catch (error) {
                    setError(`Firebase initialization failed: ${error.message}`);
                    setIsConnected(false);
                    return false;
                }
            };

            // Parse Firebase config from input and save it permanently
            const parseFirebaseConfig = () => {
                try {
                    const config = JSON.parse(configInput);
                    if (config.apiKey && config.projectId) {
                        setFirebaseConfig(config);
                        localStorage.setItem('firebaseConfig', JSON.stringify(config));  // Save permanently
                        setShowConfig(false);
                        setError(null);
                        return true;
                    } else {
                        setError('Invalid Firebase configuration. Missing required fields.');
                        return false;
                    }
                } catch (error) {
                    setError('Invalid JSON format. Please check your Firebase configuration.');
                    return false;
                }
            };

            // Load data from Firebase
            const loadData = async () => {
                if (!db) return;
                
                setIsLoading(true);
                try {
                    // Load items
                    const itemsSnapshot = await db.collection('items').get();
                    const itemsData = [];
                    itemsSnapshot.forEach(doc => {
                        itemsData.push({ id: doc.id, ...doc.data() });
                    });
                    setItems(itemsData);

                    // Load packs
                    const packsSnapshot = await db.collection('packs').get();
                    const packsData = [];
                    packsSnapshot.forEach(doc => {
                        packsData.push({ id: doc.id, ...doc.data() });
                    });
                    setPacks(packsData);
                    
                    setError(null);
                } catch (error) {
                    setError(`Failed to load data: ${error.message}`);
                } finally {
                    setIsLoading(false);
                }
            };

            // Initialize Firebase when config is available
            useEffect(() => {
                if (firebaseConfig.apiKey && firebaseConfig.projectId && !isConnected) {
                    initializeFirebase();
                }
            }, [firebaseConfig]);

            // Add new item to Firebase
            const addItem = async () => {
                if (!newItemName.trim() || !newItemStock || !db) return;
                
                try {
                    const docRef = await db.collection('items').add({
                        name: newItemName.trim(),
                        stock: parseInt(newItemStock) || 0,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    
                    const newItem = {
                        id: docRef.id,
                        name: newItemName.trim(),
                        stock: parseInt(newItemStock) || 0
                    };
                    
                    setItems(prev => [...prev, newItem]);
                    setNewItemName('');
                    setNewItemStock('');
                } catch (error) {
                    setError(`Failed to add item: ${error.message}`);
                }
            };

            // Update stock in Firebase
            const updateStock = async (id, change) => {
                const item = items.find(i => i.id === id);
                if (!item || !db) return;
                
                const newStock = Math.max(0, item.stock + change);
                
                try {
                    await db.collection('items').doc(id).update({
                        stock: newStock,
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    
                    setItems(prev => prev.map(i => 
                        i.id === id ? { ...i, stock: newStock } : i
                    ));
                } catch (error) {
                    setError(`Failed to update stock: ${error.message}`);
                }
            };

            // Delete item from Firebase
            const deleteItem = async (id) => {
                const usedInPacks = packs.filter(pack =>
                    pack.components && pack.components.some(component => component.itemId === id)
                );
                if (usedInPacks.length > 0) {
                    alert(`Cannot delete item. Used in packs: ${usedInPacks.map(p => p.name).join(', ')}`);
                    return;
                }
                
                try {
                    await db.collection('items').doc(id).delete();
                    setItems(prev => prev.filter(item => item.id !== id));
                } catch (error) {
                    setError(`Failed to delete item: ${error.message}`);
                }
            };

            // Update item name in Firebase
            const saveEdit = async () => {
                if (!editName.trim() || !db) return;
                
                try {
                    await db.collection('items').doc(editingId).update({
                        name: editName.trim(),
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    
                    setItems(prev => prev.map(item =>
                        item.id === editingId ? { ...item, name: editName.trim() } : item
                    ));
                    setEditingId(null);
                    setEditName('');
                } catch (error) {
                    setError(`Failed to update item: ${error.message}`);
                }
            };

            // Pack management functions
            const addComponentToPack = (itemId) => {
                const item = items.find(i => i.id === itemId);
                if (!item) return;
                
                const existing = packComponents.find(c => c.itemId === itemId);
                if (existing) {
                    setPackComponents(prev => prev.map(c =>
                        c.itemId === itemId ? { ...c, quantity: c.quantity + 1 } : c
                    ));
                } else {
                    setPackComponents(prev => [...prev, {
                        itemId,
                        name: item.name,
                        quantity: 1
                    }]);
                }
            };

            const addPack = async () => {
                if (!newPackName.trim() || packComponents.length === 0 || !db) return;
                
                try {
                    const docRef = await db.collection('packs').add({
                        name: newPackName.trim(),
                        components: packComponents,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    
                    const newPack = {
                        id: docRef.id,
                        name: newPackName.trim(),
                        components: [...packComponents]
                    };
                    
                    setPacks(prev => [...prev, newPack]);
                    setNewPackName('');
                    setPackComponents([]);
                    setShowPackForm(false);
                } catch (error) {
                    setError(`Failed to create pack: ${error.message}`);
                }
            };

            const deletePack = async (id) => {
                try {
                    await db.collection('packs').doc(id).delete();
                    setPacks(prev => prev.filter(pack => pack.id !== id));
                } catch (error) {
                    setError(`Failed to delete pack: ${error.message}`);
                }
            };

            // Other utility functions remain the same
            const removeComponentFromPack = (itemId) => {
                setPackComponents(prev => prev.filter(c => c.itemId !== itemId));
            };

            const updateComponentQuantity = (itemId, newQuantity) => {
                if (newQuantity <= 0) {
                    removeComponentFromPack(itemId);
                } else {
                    setPackComponents(prev => prev.map(c =>
                        c.itemId === itemId ? { ...c, quantity: newQuantity } : c
                    ));
                }
            };

            const getPackAvailability = (pack) => {
                if (!pack.components || pack.components.length === 0) return 0;
                
                let minAvailable = Infinity;
                for (const component of pack.components) {
                    const item = items.find(i => i.id === component.itemId);
                    if (item) {
                        const available = Math.floor(item.stock / component.quantity);
                        minAvailable = Math.min(minAvailable, available);
                    } else {
                        return 0;
                    }
                }
                return minAvailable === Infinity ? 0 : minAvailable;
            };

            const updatePackStock = async (packId, change) => {
                const pack = packs.find(p => p.id === packId);
                if (!pack || !pack.components) return;

                if (change < 0) {
                    const available = getPackAvailability(pack);
                    if (available < Math.abs(change)) {
                        alert(`Not enough components! Only ${available} packs available.`);
                        return;
                    }
                }

                // Update all component stocks
                const promises = pack.components.map(component => {
                    const newChange = -(component.quantity * change);
                    return updateStock(component.itemId, newChange);
                });

                try {
                    await Promise.all(promises);
                } catch (error) {
                    setError(`Failed to update pack stock: ${error.message}`);
                }
            };

            const startEdit = (item) => {
                setEditingId(item.id);
                setEditName(item.name);
            };

            const cancelEdit = () => {
                setEditingId(null);
                setEditName('');
            };

            const exportData = () => {
                const data = { items, packs };
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = 'inventory-data.json';
                link.click();
                URL.revokeObjectURL(url);
            };

            // Filter items based on search
            const filteredItems = items.filter(item => 
                item.name.toLowerCase().includes(searchQuery.toLowerCase())
            );

            // Calculate totals
            const totalStock = items.reduce((sum, item) => sum + item.stock, 0);
            const totalPacksAvailable = packs.reduce((sum, pack) => sum + getPackAvailability(pack), 0);

            // Firebase Configuration UI
            if (showConfig) {
                return (
                    <div className="min-h-screen bg-gray-50 p-4 flex items-center justify-center">
                        <div className="max-w-2xl w-full bg-white rounded-lg shadow-lg p-6">
                            <h1 className="text-3xl font-bold text-gray-800 mb-6 text-center">
                                🔥 Firebase Inventory Manager
                            </h1>
                            
                            <div className="space-y-4">
                                <div className="bg-blue-50 p-4 rounded-lg">
                                    <h2 className="font-semibold text-lg mb-2">Quick Setup (5 minutes):</h2>
                                    <ol className="text-sm space-y-1 list-decimal list-inside">
                                        <li>Go to <a href="https://console.firebase.google.com" className="text-blue-600 hover:underline" target="_blank" rel="noreferrer">Firebase Console</a></li>
                                        <li>Create a new project (or use existing)</li>
                                        <li>Go to Project Settings → General → Web apps</li>
                                        <li>Add a web app, copy the config object</li>
                                        <li>Go to Firestore Database → Create database (test mode)</li>
                                        <li>Paste your config below and click Connect</li>
                                    </ol>
                                </div>

                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-2">
                                        Firebase Configuration (JSON format):
                                    </label>
                                    <textarea
                                        value={configInput}
                                        onChange={(e) => setConfigInput(e.target.value)}
                                        placeholder={`{
  "apiKey": "your-api-key",
  "authDomain": "your-project.firebaseapp.com",
  "projectId": "your-project-id",
  "storageBucket": "your-project.appspot.com",
  "messagingSenderId": "123456789",
  "appId": "your-app-id"
}`}
                                        className="w-full h-40 px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:outline-none font-mono text-sm"
                                    />
                                </div>

                                {error && (
                                    <div className="p-3 bg-red-50 border border-red-200 rounded-md">
                                        <p className="text-red-700 text-sm">{error}</p>
                                    </div>
                                )}

                                <button
                                    onClick={parseFirebaseConfig}
                                    disabled={!configInput.trim()}
                                    className="w-full px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 disabled:bg-gray-300 disabled:cursor-not-allowed transition-colors"
                                >
                                    Connect to Firebase
                                </button>

                                <div className="text-xs text-gray-500 text-center mt-2">
                                    Your Firebase config is stored locally and never sent anywhere except to Firebase.
                                </div>
                            </div>
                        </div>
                    </div>
                );
            }

            return (
                <div className="min-h-screen bg-gray-50 p-4">
                    <div className="max-w-6xl mx-auto">
                        <div className="bg-white rounded-lg shadow-lg p-6">
                            {/* Header */}
                            <div className="flex items-center justify-between mb-6">
                                <h1 className="text-3xl font-bold text-gray-800 flex items-center gap-2">
                                    🔥 Stock Inventory Manager
                                    <span className="text-sm font-normal text-gray-500">with Firebase</span>
                                </h1>
                                <div className="flex gap-2 items-center">
                                    <div className={`w-3 h-3 rounded-full ${isConnected ? 'bg-green-500' : 'bg-red-500'}`}></div>
                                    <span className={`text-sm ${isConnected ? 'text-green-700' : 'text-red-700'}`}>
                                        {isConnected ? 'Connected' : 'Disconnected'}
                                    </span>
                                    <button
                                        onClick={exportData}
                                        className="px-3 py-1 text-sm bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors ml-4"
                                    >
                                        Export
                                    </button>
                                </div>
                            </div>

                            {error && (
                                <div className="p-3 bg-red-50 border border-red-200 rounded-md mb-6">
                                    <p className="text-red-700 text-sm">{error}</p>
                                </div>
                            )}

                            {/* Summary Cards */}
                            <div className="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                                <div className="bg-blue-50 p-4 rounded-lg">
                                    <p className="text-sm text-blue-600 font-medium">Products</p>
                                    <p className="text-2xl font-bold text-blue-800">{items.length}</p>
                                </div>
                                <div className="bg-green-50 p-4 rounded-lg">
                                    <p className="text-sm text-green-600 font-medium">Total Stock</p>
                                    <p className="text-2xl font-bold text-green-800">{totalStock}</p>
                                </div>
                                <div className="bg-purple-50 p-4 rounded-lg">
                                    <p className="text-sm text-purple-600 font-medium">Pack Types</p>
                                    <p className="text-2xl font-bold text-purple-800">{packs.length}</p>
                                </div>
                                <div className="bg-orange-50 p-4 rounded-lg">
                                    <p className="text-sm text-orange-600 font-medium">Available Packs</p>
                                    <p className="text-2xl font-bold text-orange-800">{totalPacksAvailable}</p>
                                </div>
                            </div>

                            {/* Add Item Form */}
                            <div className="border rounded-lg p-4 mb-6">
                                <h2 className="text-lg font-semibold mb-3 flex items-center gap-2">
                                    ➕ Add Product
                                </h2>
                                <div className="flex gap-3">
                                    <input
                                        type="text"
                                        placeholder="Product name"
                                        value={newItemName}
                                        onChange={(e) => setNewItemName(e.target.value)}
                                        className="flex-1 px-3 py-2 border rounded-md focus:ring-2 focus:ring-blue-500 focus:outline-none"
                                        onKeyPress={(e)
