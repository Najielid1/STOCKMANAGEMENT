<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Stock Inventory Manager - Firebase</title>
<script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
</head>
<body>
<div id="root"></div>

<script type="text/babel">
const { useState, useEffect, useRef, useCallback, useMemo } = React;

// Custom hook to handle Firebase init & API calls
function useFirebase(initialConfig) {
  const dbRef = useRef(null);
  const [isConnected, setConnected] = useState(false);
  const [error, setError] = useState(null);

  // Initialize Firebase app & Firestore
  const initialize = useCallback((config) => {
    try {
      if (!firebase.apps.length) firebase.initializeApp(config);
      dbRef.current = firebase.firestore();
      setConnected(true);
      setError(null);
      return true;
    } catch (e) {
      setError(`Firebase init error: ${e.message}`);
      setConnected(false);
      return false;
    }
  }, []);

  // Fetch items and packs
  const fetchData = useCallback(async () => {
    if (!dbRef.current) return { items: [], packs: [] };
    try {
      const itemsSnap = await dbRef.current.collection('items').get();
      const packsSnap = await dbRef.current.collection('packs').get();
      return {
        items: itemsSnap.docs.map(doc => ({ id: doc.id, ...doc.data() })),
        packs: packsSnap.docs.map(doc => ({ id: doc.id, ...doc.data() })),
      };
    } catch (e) {
      setError(`Data load failed: ${e.message}`);
      return { items: [], packs: [] };
    }
  }, []);

  // Add item
  const addItem = useCallback(async (name, stock) => {
    if (!dbRef.current) return null;
    try {
      const docRef = await dbRef.current.collection('items').add({
        name,
        stock: Number(stock) || 0,
        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
      });
      return { id: docRef.id, name, stock: Number(stock) || 0 };
    } catch (e) {
      setError(`Add item failed: ${e.message}`);
      return null;
    }
  }, []);

  // Update item stock or name
  const updateItem = useCallback(async (id, data) => {
    if (!dbRef.current) return false;
    try {
      await dbRef.current.collection('items').doc(id).update({
        ...data,
        updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
      });
      return true;
    } catch (e) {
      setError(`Update failed: ${e.message}`);
      return false;
    }
  }, []);

  // Delete item
  const deleteItem = useCallback(async (id) => {
    if (!dbRef.current) return false;
    try {
      await dbRef.current.collection('items').doc(id).delete();
      return true;
    } catch (e) {
      setError(`Delete failed: ${e.message}`);
      return false;
    }
  }, []);

  // Add pack
  const addPack = useCallback(async (name, components) => {
    if (!dbRef.current) return null;
    try {
      const docRef = await dbRef.current.collection('packs').add({
        name,
        components,
        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
      });
      return { id: docRef.id, name, components };
    } catch (e) {
      setError(`Add pack failed: ${e.message}`);
      return null;
    }
  }, []);

  // Delete pack
  const deletePack = useCallback(async (id) => {
    if (!dbRef.current) return false;
    try {
      await dbRef.current.collection('packs').doc(id).delete();
      return true;
    } catch (e) {
      setError(`Delete pack failed: ${e.message}`);
      return false;
    }
  }, []);

  // Update pack stock atomically with batch
  const updatePackStock = useCallback(async (pack, change) => {
    if (!dbRef.current) return false;
    const batch = dbRef.current.batch();

    for (const c of pack.components || []) {
      const itemRef = dbRef.current.collection('items').doc(c.itemId);
      batch.update(itemRef, {
        stock: firebase.firestore.FieldValue.increment(-c.quantity * change),
        updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
      });
    }

    try {
      await batch.commit();
      return true;
    } catch (e) {
      setError(`Update pack stock failed: ${e.message}`);
      return false;
    }
  }, []);

  return {
    dbRef,
    isConnected,
    error,
    setError,
    initialize,
    fetchData,
    addItem,
    updateItem,
    deleteItem,
    addPack,
    deletePack,
    updatePackStock,
  };
}

function StockInventoryApp() {
  // Firebase config & connection UI
  const [firebaseConfig, setFirebaseConfig] = useState(null);
  const [configInput, setConfigInput] = useState('');
  const [showConfig, setShowConfig] = useState(true);

  const {
    isConnected, error, setError, initialize, fetchData,
    addItem, updateItem, deleteItem, addPack, deletePack, updatePackStock
  } = useFirebase(firebaseConfig);

  // Data states
  const [items, setItems] = useState([]);
  const [packs, setPacks] = useState([]);
  const [loading, setLoading] = useState(false);

  // UI states
  const [newItemName, setNewItemName] = useState('');
  const [newItemStock, setNewItemStock] = useState('');
  const [search, setSearch] = useState('');
  const [showPackForm, setShowPackForm] = useState(false);
  const [newPackName, setNewPackName] = useState('');
  const [packComponents, setPackComponents] = useState([]);
  const [editingId, setEditingId] = useState(null);
  const [editName, setEditName] = useState('');

  // Init Firebase and load data when config set
  useEffect(() => {
    if (!firebaseConfig) return;
    if (initialize(firebaseConfig)) {
      setLoading(true);
      fetchData().then(({ items, packs }) => {
        setItems(items);
        setPacks(packs);
        setLoading(false);
      });
    }
  }, [firebaseConfig]);

  // Parse Firebase config JSON input
  const parseConfig = () => {
    try {
      const parsed = JSON.parse(configInput);
      if (parsed.apiKey && parsed.projectId) {
        setFirebaseConfig(parsed);
        setShowConfig(false);
        setError(null);
      } else {
        setError('Firebase config missing required fields.');
      }
    } catch {
      setError('Invalid JSON format.');
    }
  };

  // Add new item handler
  const handleAddItem = async () => {
    if (!newItemName.trim() || !newItemStock) return;
    const newItem = await addItem(newItemName.trim(), newItemStock);
    if (newItem) {
      setItems(prev => [...prev, newItem]);
      setNewItemName('');
      setNewItemStock('');
    }
  };

  // Update stock handler
  const handleUpdateStock = async (id, change) => {
    const item = items.find(i => i.id === id);
    if (!item) return;
    const newStock = Math.max(0, item.stock + change);
    if (await updateItem(id, { stock: newStock })) {
      setItems(items.map(i => i.id === id ? { ...i, stock: newStock } : i));
    }
  };

  // Delete item handler with pack check
  const handleDeleteItem = async (id) => {
    if (packs.some(pack => pack.components?.some(c => c.itemId === id))) {
      alert('Item used in a pack. Remove from packs first.');
      return;
    }
    if (await deleteItem(id)) {
      setItems(items.filter(i => i.id !== id));
    }
  };

  // Edit item name
  const saveEditName = async () => {
    if (!editName.trim() || !editingId) return;
    if (await updateItem(editingId, { name: editName.trim() })) {
      setItems(items.map(i => i.id === editingId ? { ...i, name: editName.trim() } : i));
      setEditingId(null);
      setEditName('');
    }
  };

  // Pack component handlers
  const addComponentToPack = (itemId) => {
    const item = items.find(i => i.id === itemId);
    if (!item) return;
    setPackComponents(pc => {
      const exists = pc.find(c => c.itemId === itemId);
      if (exists) return pc.map(c => c.itemId === itemId ? { ...c, quantity: c.quantity + 1 } : c);
      return [...pc, { itemId, name: item.name, quantity: 1 }];
    });
  };
  const removeComponentFromPack = (itemId) => {
    setPackComponents(pc => pc.filter(c => c.itemId !== itemId));
  };
  const updateComponentQuantity = (itemId, q) => {
    if (q <= 0) removeComponentFromPack(itemId);
    else setPackComponents(pc => pc.map(c => c.itemId === itemId ? { ...c, quantity: q } : c));
  };

  // Calculate pack availability
  const getPackAvailability = useCallback((pack) => {
    if (!pack.components?.length) return 0;
    return Math.min(...pack.components.map(c => {
      const item = items.find(i => i.id === c.itemId);
      return item ? Math.floor(item.stock / c.quantity) : 0;
    }));
  }, [items]);

  // Add pack handler
  const handleAddPack = async () => {
    if (!newPackName.trim() || packComponents.length === 0) return;
    const newPack = await addPack(newPackName.trim(), packComponents);
    if (newPack) {
      setPacks(prev => [...prev, newPack]);
      setNewPackName('');
      setPackComponents([]);
      setShowPackForm(false);
    }
  };

  // Delete pack handler
  const handleDeletePack = async (id) => {
    if (await deletePack(id)) {
      setPacks(prev => prev.filter(p => p.id !== id));
    }
  };

  // Update pack stock handler (uses batch)
  const handleUpdatePackStock = async (packId, change) => {
    const pack = packs.find(p => p.id === packId);
    if (!pack) return;

    const available = getPackAvailability(pack);
    if (change < 0 && available < Math.abs(change)) {
      alert(`Not enough stock for ${pack.name}. Only ${available} available.`);
      return;
    }

    if (await updatePackStock(pack, change)) {
      // Refresh items from firestore to get latest stocks
      const { items: freshItems } = await fetchData();
      setItems(freshItems);
    }
  };

  // Filter items for search
  const filteredItems = useMemo(() =>
    items.filter(i => i.name.toLowerCase().includes(search.toLowerCase()))
  , [items, search]);

  // Totals
  const totalStock = useMemo(() => items.reduce((a, i) => a + i.stock, 0), [items]);
  const totalPacksAvailable = useMemo(() => packs.reduce((a, p) => a + getPackAvailability(p), 0), [packs, getPackAvailability]);

  // Export data JSON
  const exportData = () => {
    const data = { items, packs };
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'inventory-data.json';
    a.click();
    URL.revokeObjectURL(url);
  };

  // === UI Components ===

  if (showConfig) return (
    <div className="min-h-screen bg-gray-50 p-4 flex items-center justify-center">
      <div className="max-w-2xl w-full bg-white rounded-lg shadow-lg p-6">
        <h1 className="text-3xl font-bold mb-6 text-center">ðŸ”¥ Firebase Inventory Manager</h1>
        <div className="bg-blue-50 p-4 rounded-lg mb-4">
          <ol className="list-decimal list-inside text-sm space-y-1">
            <li>Go to <a href="https://console.firebase.google.com" className="text-blue-600" target="_blank" rel="noreferrer">Firebase Console</a></li>
            <li>Create a project and add a web app</li>
            <li>Enable Firestore (test mode)</li>
            <li>Copy the config JSON and paste below</li>
            <li>Click Connect</li>
          </ol>
        </div>
        <textarea
          rows={10}
          className="w-full border rounded-md p-2 font-mono text-sm"
          placeholder='Paste your Firebase config JSON here...'
          value={configInput}
          onChange={e => setConfigInput(e.target.value)}
        />
        {error && <p className="mt-2 text-red-600">{error}</p>}
        <button
          onClick={parseConfig}
          disabled={!configInput.trim()}
          className="mt-4 w-full bg-blue-600 text-white py-2 rounded hover:bg-blue-700 disabled:bg-gray-300"
        >
          Connect to Firebase
        </button>
        <p className="text-xs text-gray-500 mt-2 text-center">Your config is stored locally and never sent anywhere except Firebase.</p>
      </div>
    </div>
  );

  // Main app UI
  return (
    <div className="min-h-screen bg-gray-50 p-4">
      <div className="max-w-6xl mx-auto bg-white rounded-lg shadow-lg p-6">
        {/* Header */}
        <div className="flex justify-between items-center mb-6">
          <h1 className="text-3xl font-bold flex items-center gap-2">
            ðŸ”¥ Stock Inventory Manager <span className="text-sm text-gray-500 font-normal">with Firebase</span>
          </h1>
          <div className="flex items-center gap-2">
            <div className={`w-3 h-3 rounded-full ${isConnected ? 'bg-green-500' : 'bg-red-500'}`}></div>
            <span className={`text-sm ${isConnected ? 'text-green-700' : 'text-red-700'}`}>
              {isConnected ? 'Connected' : 'Disconnected'}
            </span>
            <button
              onClick={exportData}
              className="ml-4 bg-blue-600 hover:bg-blue-700 text-white rounded px-3 py-1 text-sm"
            >Export</button>
          </div>
        </div>

        {error && <p className="mb-6 text-red-600">{error}</p>}

        {/* Summary Cards */}
        <div className="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
          {[
            { label: 'Products', value: items.length, color: 'blue' },
            { label: 'Total Stock', value: totalStock, color: 'green' },
            { label: 'Pack Types', value: packs.length, color: 'purple' },
            { label: 'Available Packs', value: totalPacksAvailable, color: 'orange' }
          ].map(({ label, value, color }) => (
            <div key={label} className={`bg-${color}-50 p-4 rounded-lg`}>
              <p className={`text-sm font-medium text-${color}-600`}>{label}</p>
              <p className={`text-2xl font-bold text-${color}-800`}>{value}</p>
            </div>
          ))}
        </div>

        {/* Add Item Form */}
        <div className="border rounded-lg p-4 mb-6">
          <h2 className="text-lg font-semibold mb-3 flex items-center gap-2">âž• Add Product</h2>
          <div className="flex gap-3">
            <input
              type="text"
              placeholder="Product name"
              value={newItemName}
              onChange={e => setNewItemName(e.target.value)}
              onKeyDown={e => e.key === 'Enter' && handleAddItem()}
              className="flex-1 px-3 py-2 border rounded-md focus:ring-2 focus:ring-blue-500"
            />
            <input
              type="number"
              placeholder="Stock"
              value={newItemStock}
              onChange={e => setNewItemStock(e.target.value)}
              onKeyDown={e => e.key === 'Enter' && handleAddItem()}
              className="w-32 px-3 py-2 border rounded-md focus:ring-2 focus:ring-blue-500"
            />
            <button
              onClick={handleAddItem}
              disabled={!newItemName.trim() || !newItemStock || !isConnected}
              className="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 disabled:bg-gray-300"
            >
              Add
            </button>
          </div>
        </div>

        {/* Pack Form */}
        <div className="border rounded-lg p-4 mb-6">
          <div className="flex justify-between items-center mb-3">
            <h2 className="text-lg font-semibold flex items-center gap-2">ðŸ“¦ Packs</h2>
            <button
              onClick={() => setShowPackForm(!showPackForm)}
              className="text-sm bg-green-600 text-white rounded px-3 py-1 hover:bg-green-700"
            >
              {showPackForm ? 'Cancel' : 'Add Pack'}
            </button>
          </div>
          {showPackForm ? (
            <div className="mb-4">
              <input
                type="text"
                placeholder="Pack name"
                value={newPackName}
                onChange={e => setNewPackName(e.target.value)}
                className="w-full px-3 py-2 border rounded-md focus:ring-2 focus:ring-green-500 mb-2"
              />
              <p className="mb-1 font-semibold">Add components:</p>
              <div className="flex flex-wrap gap-2 mb-2 max-h-40 overflow-auto border p-2 rounded">
                {items.map(item => (
                  <button
                    key={item.id}
                    onClick={() => addComponentToPack(item.id)}
                    disabled={packComponents.some(c => c.itemId === item.id)}
                    className="bg-blue-200 hover:bg-blue-300 rounded px-2 py-1 text-xs"
                  >
                    {item.name}
                  </button>
                ))}
              </div>

              {/* Pack Components List */}
              {packComponents.length === 0 ? (
                <p className="text-sm italic text-gray-500">No components added yet.</p>
              ) : (
                <ul className="mb-4">
                  {packComponents.map(({ itemId, name, quantity }) => (
                    <li key={itemId} className="flex items-center gap-2 mb-1">
                      <span className="flex-1">{name}</span>
                      <input
                        type="number"
                        min="1"
                        value={quantity}
                        onChange={e => updateComponentQuantity(itemId, Number(e.target.value))}
                        className="w-16 px-2 py-1 border rounded"
                      />
                      <button
                        onClick={() => removeComponentFromPack(itemId)}
                        className="text-red-600 hover:text-red-800"
                        title="Remove component"
                      >
                        &times;
                      </button>
                    </li>
                  ))}
                </ul>
              )}
              <button
                onClick={handleAddPack}
                disabled={!newPackName.trim() || packComponents.length === 0}
                className="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 disabled:bg-gray-300"
              >
                Save Pack
              </button>
            </div>
          ) : (
            <div>
              {packs.length === 0 ? (
                <p className="text-sm italic text-gray-500">No packs available.</p>
              ) : (
                <ul>
                  {packs.map(pack => (
                    <li key={pack.id} className="border rounded p-3 mb-3 flex flex-col md:flex-row md:items-center md:justify-between">
                      <div>
                        <p className="font-semibold">{pack.name}</p>
                        <p className="text-sm text-gray-600">Components: {pack.components?.length || 0}</p>
                        <p className="text-sm text-gray-600">Available: {getPackAvailability(pack)}</p>
                      </div>
                      <div className="flex gap-2 mt-2 md:mt-0">
                        <button
                          onClick={() => handleUpdatePackStock(pack.id, -1)}
                          className="bg-red-500 text-white px-3 py-1 rounded hover:bg-red-600"
                        >
                          -1
                        </button>
                        <button
                          onClick={() => handleUpdatePackStock(pack.id, 1)}
                          className="bg-green-500 text-white px-3 py-1 rounded hover:bg-green-600"
                        >
                          +1
                        </button>
                        <button
                          onClick={() => {
                            if (window.confirm(`Delete pack "${pack.name}"?`)) handleDeletePack(pack.id);
                          }}
                          className="bg-gray-300 hover:bg-gray-400 rounded px-3 py-1"
                        >
                          Delete
                        </button>
                      </div>
                    </li>
                  ))}
                </ul>
              )}
            </div>
          )}
        </div>

        {/* Search + Items List */}
        <div>
          <input
            type="search"
            placeholder="Search products..."
            value={search}
            onChange={e => setSearch(e.target.value)}
            className="w-full px-3 py-2 border rounded mb-3 focus:ring-2 focus:ring-indigo-500"
          />
          {loading ? (
            <p>Loading...</p>
          ) : filteredItems.length === 0 ? (
            <p>No products found.</p>
          ) : (
            <ul>
              {filteredItems.map(item => (
                <li key={item.id} className="border rounded p-3 mb-3 flex flex-col md:flex-row md:items-center md:justify-between gap-2">
                  <div className="flex items-center gap-2 flex-1">
                    {editingId === item.id ? (
                      <>
                        <input
                          type="text"
                          value={editName}
                          onChange={e => setEditName(e.target.value)}
                          className="flex-1 px-2 py-1 border rounded"
                        />
                        <button
                          onClick={saveEditName}
                          className="bg-green-600 text-white px-3 py-1 rounded hover:bg-green-700"
                        >
                          Save
                        </button>
                        <button
                          onClick={() => setEditingId(null)}
                          className="bg-gray-300 px-3 py-1 rounded hover:bg-gray-400"
                        >
                          Cancel
                        </button>
                      </>
                    ) : (
                      <>
                        <p className="font-semibold">{item.name}</p>
                        <button
                          onClick={() => {
                            setEditingId(item.id);
                            setEditName(item.name);
                          }}
                          className="text-blue-600 hover:underline text-sm"
                        >
                          Edit
                        </button>
                      </>
                    )}
                  </div>
                  <div className="flex items-center gap-3">
                    <button
                      onClick={() => handleUpdateStock(item.id, -1)}
                      disabled={item.stock <= 0}
                      className="bg-red-500 text-white px-3 py-1 rounded hover:bg-red-600 disabled:bg-gray-300"
                    >
                      -
                    </button>
                    <p className="font-mono w-12 text-center">{item.stock}</p>
                    <button
                      onClick={() => handleUpdateStock(item.id, 1)}
                      className="bg-green-500 text-white px-3 py-1 rounded hover:bg-green-600"
                    >
                      +
                    </button>
                    <button
                      onClick={() => {
                        if (window.confirm(`Delete product "${item.name}"?`)) handleDeleteItem(item.id);
                      }}
                      className="bg-gray-300 hover:bg-gray-400 rounded px-3 py-1"
                    >
                      Delete
                    </button>
                  </div>
                </li>
              ))}
            </ul>
          )}
        </div>

      </div>
    </div>
  );
}

ReactDOM.createRoot(document.getElementById('root')).render(<StockInventoryApp />);
</script>
</body>
</html>
