<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Stock Inventory Manager - Firebase</title>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
</head>
<body class="bg-gray-50">

<div id="root"></div>

<script type="text/babel">
  const { useState, useEffect } = React;

  function StockInventoryApp() {
    // === FIREBASE CONFIG - PUT YOUR OWN CONFIG HERE ===
    const firebaseConfig = {
      apiKey: "AIzaSyDXswzHsLKCTw5z5K4BWYCoolfogybbnvE",
      authDomain: "batal-games.firebaseapp.com",
      projectId: "batal-games",
      storageBucket: "batal-games.firebasestorage.app",
      messagingSenderId: "535042272877",
      appId: "1:535042272877:web:708036abcab58625385964",
    };

    const [isConnected, setIsConnected] = useState(false);
    const [db, setDb] = useState(null);

    // App states
    const [items, setItems] = useState([]);
    const [packs, setPacks] = useState([]);
    const [isLoading, setIsLoading] = useState(false);
    const [error, setError] = useState(null);

    // Login
    const [loggedIn, setLoggedIn] = useState(false);
    const [passwordInput, setPasswordInput] = useState("");
    const PASSWORD = "admin123"; // Change this to your desired password

    // Add Item form
    const [newItemName, setNewItemName] = useState("");
    const [newItemStock, setNewItemStock] = useState("");

    // Pack form
    const [showPackForm, setShowPackForm] = useState(false);
    const [newPackName, setNewPackName] = useState("");
    const [packComponents, setPackComponents] = useState([]);

    // Search
    const [searchQuery, setSearchQuery] = useState("");

    // Disable buttons while updating
    const [updatingIds, setUpdatingIds] = useState(new Set());

    // Initialize Firebase only once
    useEffect(() => {
      if (!firebase.apps.length) {
        firebase.initializeApp(firebaseConfig);
      }
      const firestore = firebase.firestore();
      setDb(firestore);
      setIsConnected(true);
    }, []);

    // Load data (items and packs)
    const loadData = async () => {
      if (!db) return;
      setIsLoading(true);
      setError(null);
      try {
        const itemsSnap = await db.collection("items").get();
        const itemsData = [];
        itemsSnap.forEach(doc => itemsData.push({ id: doc.id, ...doc.data() }));
        setItems(itemsData);

        const packsSnap = await db.collection("packs").get();
        const packsData = [];
        packsSnap.forEach(doc => packsData.push({ id: doc.id, ...doc.data() }));
        setPacks(packsData);
      } catch (err) {
        setError("Failed to load data: " + err.message);
      } finally {
        setIsLoading(false);
      }
    };

    // Load data on login or db ready
    useEffect(() => {
      if (loggedIn && db) {
        loadData();
      }
    }, [loggedIn, db]);

    // Utility to add/remove id from updatingIds set (to disable buttons)
    const toggleUpdating = (id, flag) => {
      setUpdatingIds(prev => {
        const newSet = new Set(prev);
        if (flag) newSet.add(id);
        else newSet.delete(id);
        return newSet;
      });
    };

    // Firestore transaction stock update for items
    const updateStock = async (id, change) => {
      if (!db) return;
      if (updatingIds.has(id)) return; // prevent double update
      toggleUpdating(id, true);
      try {
        const itemRef = db.collection("items").doc(id);
        await db.runTransaction(async (tx) => {
          const doc = await tx.get(itemRef);
          if (!doc.exists) throw new Error("Item does not exist");
          const currentStock = doc.data().stock || 0;
          const newStock = Math.max(0, currentStock + change);
          tx.update(itemRef, { stock: newStock, updatedAt: firebase.firestore.FieldValue.serverTimestamp() });
        });
        setItems(prev => prev.map(i => i.id === id ? { ...i, stock: Math.max(0, i.stock + change) } : i));
        setError(null);
      } catch (err) {
        setError("Failed to update stock: " + err.message);
      } finally {
        toggleUpdating(id, false);
      }
    };

    // Firestore transaction stock update for packs (updates components)
    const updatePackStock = async (packId, change) => {
      if (!db) return;
      if (updatingIds.has(packId)) return;
      toggleUpdating(packId, true);

      const pack = packs.find(p => p.id === packId);
      if (!pack || !pack.components) {
        setError("Pack not found or has no components");
        toggleUpdating(packId, false);
        return;
      }

      // Check availability first
      const available = getPackAvailability(pack);
      if (change < 0 && available < Math.abs(change)) {
        alert(`Not enough components! Only ${available} packs available.`);
        toggleUpdating(packId, false);
        return;
      }

      try {
        const batch = db.batch();
        // Update each component inside a transaction
        await Promise.all(pack.components.map(async (component) => {
          const itemRef = db.collection("items").doc(component.itemId);
          await db.runTransaction(async (tx) => {
            const doc = await tx.get(itemRef);
            if (!doc.exists) throw new Error(`Item ${component.name} does not exist`);
            const currentStock = doc.data().stock || 0;
            const newStock = Math.max(0, currentStock - (component.quantity * change));
            tx.update(itemRef, { stock: newStock, updatedAt: firebase.firestore.FieldValue.serverTimestamp() });
          });
        }));
        // Update local items state accordingly
        setItems(prev => prev.map(item => {
          const comp = pack.components.find(c => c.itemId === item.id);
          if (comp) {
            const newStock = item.stock - (comp.quantity * change);
            return { ...item, stock: Math.max(0, newStock) };
          }
          return item;
        }));
        setError(null);
      } catch (err) {
        setError("Failed to update pack stock: " + err.message);
      } finally {
        toggleUpdating(packId, false);
      }
    };

    // Add new item
    const addItem = async () => {
      if (!newItemName.trim() || isNaN(parseInt(newItemStock)) || !db) return;
      setIsLoading(true);
      setError(null);
      try {
        const docRef = await db.collection("items").add({
          name: newItemName.trim(),
          stock: parseInt(newItemStock),
          createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        });
        setItems(prev => [...prev, { id: docRef.id, name: newItemName.trim(), stock: parseInt(newItemStock) }]);
        setNewItemName("");
        setNewItemStock("");
      } catch (err) {
        setError("Failed to add item: " + err.message);
      } finally {
        setIsLoading(false);
      }
    };

    // Pack helpers
    const addComponentToPack = (itemId) => {
      const item = items.find(i => i.id === itemId);
      if (!item) return;
      const existing = packComponents.find(c => c.itemId === itemId);
      if (existing) {
        setPackComponents(prev => prev.map(c => c.itemId === itemId ? { ...c, quantity: c.quantity + 1 } : c));
      } else {
        setPackComponents(prev => [...prev, { itemId, name: item.name, quantity: 1 }]);
      }
    };

    const removeComponentFromPack = (itemId) => {
      setPackComponents(prev => prev.filter(c => c.itemId !== itemId));
    };

    const updateComponentQuantity = (itemId, newQuantity) => {
      if (newQuantity <= 0) {
        removeComponentFromPack(itemId);
      } else {
        setPackComponents(prev => prev.map(c => c.itemId === itemId ? { ...c, quantity: newQuantity } : c));
      }
    };

    // Create new pack
    const addPack = async () => {
      if (!newPackName.trim() || packComponents.length === 0 || !db) return;
      setIsLoading(true);
      setError(null);
      try {
        const docRef = await db.collection("packs").add({
          name: newPackName.trim(),
          components: packComponents,
          createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        });
        setPacks(prev => [...prev, { id: docRef.id, name: newPackName.trim(), components: packComponents }]);
        setNewPackName("");
        setPackComponents([]);
        setShowPackForm(false);
      } catch (err) {
        setError("Failed to create pack: " + err.message);
      } finally {
        setIsLoading(false);
      }
    };

    // Delete item (only if not used in packs)
    const deleteItem = async (id) => {
      if (!db) return;
      const usedInPacks = packs.filter(pack =>
        pack.components && pack.components.some(c => c.itemId === id)
      );
      if (usedInPacks.length) {
        alert("Cannot delete item. Used in packs: " + usedInPacks.map(p => p.name).join(", "));
        return;
      }
      setIsLoading(true);
      setError(null);
      try {
        await db.collection("items").doc(id).delete();
        setItems(prev => prev.filter(i => i.id !== id));
      } catch (err) {
        setError("Failed to delete item: " + err.message);
      } finally {
        setIsLoading(false);
      }
    };

    // Delete pack
    const deletePack = async (id) => {
      if (!db) return;
      setIsLoading(true);
      setError(null);
      try {
        await db.collection("packs").doc(id).delete();
        setPacks(prev => prev.filter(p => p.id !== id));
      } catch (err) {
        setError("Failed to delete pack: " + err.message);
      } finally {
        setIsLoading(false);
      }
    };

    // Calculate pack availability = min available across components
    const getPackAvailability = (pack) => {
      if (!pack.components || pack.components.length === 0) return 0;
      let minAvailable = Infinity;
      for (const c of pack.components) {
        const item = items.find(i => i.id === c.itemId);
        if (!item) return 0;
        const avail = Math.floor(item.stock / c.quantity);
        minAvailable = Math.min(minAvailable, avail);
      }
      return minAvailable === Infinity ? 0 : minAvailable;
    };

    // Filtered items by search
    const filteredItems = items.filter(i =>
      i.name.toLowerCase().includes(searchQuery.toLowerCase())
    );

    // Total counts
    const totalStock = items.reduce((sum, i) => sum + i.stock, 0);
    const totalPacksAvailable = packs.reduce((sum, p) => sum + getPackAvailability(p), 0);

    // --- PASSWORD LOGIN SCREEN ---
    if (!loggedIn) {
      return (
        <div className="min-h-screen flex items-center justify-center p-4 bg-gray-50">
          <div className="bg-white p-8 rounded shadow max-w-sm w-full">
            <h1 className="text-2xl font-bold mb-6 text-center">🔐 Enter Password</h1>
            <input
              type="password"
              placeholder="Password"
              className="w-full px-4 py-2 border rounded mb-4 focus:outline-none focus:ring-2 focus:ring-blue-600"
              value={passwordInput}
              onChange={(e) => setPasswordInput(e.target.value)}
              onKeyDown={e => e.key === "Enter" && (passwordInput === PASSWORD ? setLoggedIn(true) : alert("Wrong password"))}
            />
            <button
              onClick={() => {
                if (passwordInput === PASSWORD) setLoggedIn(true);
                else alert("Wrong password");
              }}
              className="w-full bg-blue-600 text-white py-2 rounded hover:bg-blue-700 transition"
            >
              Login
            </button>
          </div>
        </div>
      );
    }

    // --- MAIN APP UI ---
    return (
      <div className="min-h-screen p-4 max-w-6xl mx-auto">
        <div className="bg-white rounded shadow p-6">

          {/* Header */}
          <div className="flex justify-between items-center mb-6">
            <h1 className="text-3xl font-bold flex items-center gap-2">
              🔥 Stock Inventory Manager
              <span className="text-sm font-normal text-gray-500">with Firebase</span>
            </h1>
            <button
              onClick={() => {
                setLoggedIn(false);
                setPasswordInput("");
              }}
              className="px-3 py-1 bg-red-600 text-white rounded hover:bg-red-700 transition"
              title="Logout"
            >
              Logout
            </button>
          </div>

          {error && (
            <div className="mb-4 p-3 bg-red-100 text-red-700 rounded">{error}</div>
          )}

          {/* Summary Cards */}
          <div className="grid grid-cols-1 sm:grid-cols-4 gap-4 mb-6 text-center">
            <div className="bg-blue-50 rounded p-4 text-blue-700 font-semibold">
              Products
              <div className="text-3xl font-bold">{items.length}</div>
            </div>
            <div className="bg-green-50 rounded p-4 text-green-700 font-semibold">
              Total Stock
              <div className="text-3xl font-bold">{totalStock}</div>
            </div>
            <div className="bg-purple-50 rounded p-4 text-purple-700 font-semibold">
              Pack Types
              <div className="text-3xl font-bold">{packs.length}</div>
            </div>
            <div className="bg-orange-50 rounded p-4 text-orange-700 font-semibold">
              Available Packs
              <div className="text-3xl font-bold">{totalPacksAvailable}</div>
            </div>
          </div>

          {/* Add Item Form */}
          <div className="mb-6 border rounded p-4">
            <h2 className="font-semibold mb-3 flex items-center gap-2 text-lg">
              ➕ Add Product
            </h2>
            <div className="flex gap-3 flex-wrap">
              <input
                type="text"
                placeholder="Product name"
                value={newItemName}
                onChange={e => setNewItemName(e.target.value)}
                className="flex-grow px-3 py-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-600"
                onKeyDown={e => e.key === "Enter" && addItem()}
                disabled={isLoading}
              />
              <input
                type="number"
                placeholder="Stock"
                value={newItemStock}
                onChange={e => setNewItemStock(e.target.value)}
                className="w-24 px-3 py-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-600"
                onKeyDown={e => e.key === "Enter" && addItem()}
                disabled={isLoading}
                min="0"
              />
              <button
                onClick={addItem}
                disabled={!newItemName.trim() || !newItemStock || isLoading}
                className="bg-blue-600 hover:bg-blue-700 disabled:bg-blue-300 text-white px-4 rounded transition"
              >
                Add
              </button>
            </div>
          </div>

          {/* Search */}
          <div className="mb-6">
            <input
              type="text"
              placeholder="Search products & packs..."
              value={searchQuery}
              onChange={e => setSearchQuery(e.target.value)}
              className="w-full px-4 py-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-600"
            />
          </div>

          {/* Products List */}
          <div className="mb-8">
            <h2 className="text-xl font-semibold mb-3">Products</h2>
            <div className="overflow-x-auto">
              <table className="w-full border border-gray-200 rounded table-auto">
                <thead className="bg-gray-100">
                  <tr>
                    <th className="p-2 text-left">Name</th>
                    <th className="p-2 w-20 text-center">Stock</th>
                    <th className="p-2 w-48 text-center">Adjust Stock</th>
                    <th className="p-2 w-20 text-center">Delete</th>
                  </tr>
                </thead>
                <tbody>
                  {filteredItems.length === 0 && (
                    <tr>
                      <td colSpan="4" className="text-center p-4 text-gray-500">
                        No products found.
                      </td>
                    </tr>
                  )}
                  {filteredItems.map(item => (
                    <tr key={item.id} className="border-b">
                      <td className="p-2">{item.name}</td>
                      <td className="p-2 text-center font-mono">{item.stock}</td>
                      <td className="p-2 flex justify-center items-center gap-1">
                        {/* Quick buttons */}
                        <button
                          onClick={() => updateStock(item.id, -1)}
                          disabled={item.stock <= 0 || updatingIds.has(item.id)}
                          className="btn"
                          title="Subtract 1"
                        >
                          −
                        </button>
                        <button
                          onClick={() => updateStock(item.id, 1)}
                          disabled={updatingIds.has(item.id)}
                          className="btn"
                          title="Add 1"
                        >
                          +
                        </button>

                        {/* Custom input for add/subtract */}
                        <CustomAdjust
                          onAdjust={change => updateStock(item.id, change)}
                          disabled={updatingIds.has(item.id)}
                        />
                      </td>
                      <td className="p-2 text-center">
                        <button
                          onClick={() => {
                            if (window.confirm("Delete this product?")) deleteItem(item.id);
                          }}
                          disabled={updatingIds.has(item.id)}
                          className="btn btn-danger"
                          title="Delete product"
                        >
                          🗑️
                        </button>
                      </td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          </div>

          {/* Packs Section */}
          <div className="mb-8">
            <div className="flex justify-between items-center mb-3">
              <h2 className="text-xl font-semibold">Packs</h2>
              <button
                onClick={() => setShowPackForm(!showPackForm)}
                className="bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded transition"
              >
                {showPackForm ? "Cancel" : "Add Pack"}
              </button>
            </div>

            {showPackForm && (
              <div className="border p-4 rounded mb-6 bg-green-50">
                <input
                  type="text"
                  placeholder="Pack name"
                  value={newPackName}
                  onChange={e => setNewPackName(e.target.value)}
                  className="w-full mb-3 px-3 py-2 border rounded focus:outline-none focus:ring-2 focus:ring-green-600"
                />

                <h3 className="font-semibold mb-2">Add components</h3>
                <div className="flex flex-wrap gap-2 mb-3 max-h-36 overflow-y-auto border p-2 bg-white rounded">
                  {filteredItems.map(item => {
                    const inPack = packComponents.find(c => c.itemId === item.id);
                    return (
                      <button
                        key={item.id}
                        onClick={() => addComponentToPack(item.id)}
                        disabled={isLoading}
                        className={`px-3 py-1 rounded border ${
                          inPack ? "bg-green-400 text-white" : "bg-gray-100 hover:bg-gray-200"
                        }`}
                      >
                        {item.name}
                      </button>
                    );
                  })}
                </div>

                <div>
                  {packComponents.length === 0 && (
                    <p className="text-gray-500 mb-3">No components added yet.</p>
                  )}
                  {packComponents.map(c => (
                    <div
                      key={c.itemId}
                      className="flex items-center gap-2 mb-2 flex-wrap"
                    >
                      <ComponentTag
                        name={c.name}
                        quantity={c.quantity}
                        onQuantityChange={q => updateComponentQuantity(c.itemId, q)}
                        onRemove={() => removeComponentFromPack(c.itemId)}
                      />
                    </div>
                  ))}
                </div>

                <button
                  onClick={addPack}
                  disabled={!newPackName.trim() || packComponents.length === 0 || isLoading}
                  className="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded transition"
                >
                  Create Pack
                </button>
              </div>
            )}

            {/* Packs List */}
            {packs.length === 0 && (
              <p className="text-gray-500">No packs created yet.</p>
            )}

            {packs.length > 0 && (
              <div className="overflow-x-auto">
                <table className="w-full border border-gray-200 rounded table-auto">
                  <thead className="bg-gray-100">
                    <tr>
                      <th className="p-2 text-left">Pack Name</th>
                      <th className="p-2">Availability</th>
                      <th className="p-2 text-center">Components</th>
                      <th className="p-2 text-center">Adjust Stock</th>
                      <th className="p-2 text-center">Delete</th>
                    </tr>
                  </thead>
                  <tbody>
                    {packs.map(pack => (
                      <tr key={pack.id} className="border-b">
                        <td className="p-2 font-semibold">{pack.name}</td>
                        <td className="p-2 text-center font-mono">{getPackAvailability(pack)}</td>
                        <td className="p-2 flex flex-wrap gap-1 justify-center max-w-sm">
                          {(pack.components || []).map(c => (
                            <PackComponentTag key={c.itemId} name={c.name} quantity={c.quantity} />
                          ))}
                        </td>
                        <td className="p-2 flex justify-center items-center gap-1">
                          <button
                            onClick={() => updatePackStock(pack.id, -1)}
                            disabled={getPackAvailability(pack) <= 0 || updatingIds.has(pack.id)}
                            className="btn"
                            title="Subtract 1 pack"
                          >
                            −
                          </button>
                          <button
                            onClick={() => updatePackStock(pack.id, 1)}
                            disabled={updatingIds.has(pack.id)}
                            className="btn"
                            title="Add 1 pack"
                          >
                            +
                          </button>
                          <CustomAdjust
                            onAdjust={change => updatePackStock(pack.id, change)}
                            disabled={updatingIds.has(pack.id)}
                          />
                        </td>
                        <td className="p-2 text-center">
                          <button
                            onClick={() => {
                              if (window.confirm("Delete this pack?")) deletePack(pack.id);
                            }}
                            disabled={updatingIds.has(pack.id)}
                            className="btn btn-danger"
                            title="Delete pack"
                          >
                            🗑️
                          </button>
                        </td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>
            )}
          </div>
        </div>
      </div>
    );
  }

  // CustomAdjust Component: input + Add / Subtract buttons
  function CustomAdjust({ onAdjust, disabled }) {
    const [value, setValue] = useState("");

    const submit = () => {
      const num = parseInt(value);
      if (isNaN(num) || num === 0) {
        alert("Enter a non-zero number");
        return;
      }
      onAdjust(num);
      setValue("");
    };

    return (
      <div className="flex items-center gap-1">
        <input
          type="number"
          min="1"
          placeholder="+/- n"
          className="w-16 px-2 py-1 border rounded text-center focus:outline-none focus:ring-2 focus:ring-blue-600"
          value={value}
          onChange={e => setValue(e.target.value)}
          disabled={disabled}
          onKeyDown={e => e.key === "Enter" && submit()}
        />
        <button
          onClick={submit}
          disabled={disabled}
          className="btn btn-primary px-2 py-1"
          title="Apply custom quantity"
        >
          ✔
        </button>
      </div>
    );
  }

  // Tag for pack component with quantity + remove
  function ComponentTag({ name, quantity, onQuantityChange, onRemove }) {
    return (
      <div className="bg-green-200 text-green-900 rounded-full px-3 py-1 flex items-center gap-2">
        <span>{name}</span>
        <input
          type="number"
          min="1"
          className="w-12 text-center rounded border border-green-400 focus:outline-none focus:ring-1 focus:ring-green-500"
          value={quantity}
          onChange={e => onQuantityChange(parseInt(e.target.value) || 1)}
        />
        <button
          onClick={onRemove}
          className="text-red-600 font-bold hover:text-red-800"
          title="Remove component"
        >
          ×
        </button>
      </div>
    );
  }

  // Colored tag for pack components (read-only)
  function PackComponentTag({ name, quantity }) {
    // Assign color based on name hash
    const colors = ["bg-pink-300 text-pink-900", "bg-purple-300 text-purple-900", "bg-indigo-300 text-indigo-900", "bg-teal-300 text-teal-900", "bg-yellow-300 text-yellow-900"];
    const colorIndex = name
      .split("")
      .reduce((acc, c) => acc + c.charCodeAt(0), 0) % colors.length;
    return (
      <span className={`rounded-full px-3 py-1 text-xs font-semibold ${colors[colorIndex]}`} title={`${name} ×${quantity}`}>
        {name} ×{quantity}
      </span>
    );
  }

  // Basic button styles using Tailwind + some custom
  const style = document.createElement("style");
  style.textContent = `
    .btn {
      @apply px-3 py-1 rounded border border-gray-300 text-gray-700 hover:bg-gray-100 disabled:opacity-50 disabled:cursor-not-allowed transition;
      font-weight: 600;
      user-select: none;
    }
    .btn-primary {
      @apply bg-blue-600 text-white border-transparent hover:bg-blue-700 disabled:bg-blue-300;
    }
    .btn-danger {
      @apply bg-red-600 text-white border-transparent hover:bg-red-700 disabled:bg-red-300;
    }
    .btn-small {
      @apply px-2 py-0.5 text-sm;
    }
  `;
  document.head.appendChild(style);

  ReactDOM.createRoot(document.getElementById("root")).render(<StockInventoryApp />);
</script>
</body>
</html>
